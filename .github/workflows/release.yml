name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Setup uv
        uses: astral-sh/setup-uv@v6

      - name: Install dependencies
        run: uv sync --frozen

      - name: Build Cython extension
        run: uv run --with Cython python build_cython_vector_hotspot.py build_ext --inplace

      - name: Verify Cython extension artifact
        shell: pwsh
        run: |
          $mods = Get-ChildItem -Path . -Include "vector_hotspot_cython_nogil*.pyd","vector_hotspot_cython_nogil*.so" -File -Recurse -ErrorAction SilentlyContinue
          if (-not $mods -or $mods.Count -eq 0) {
            throw "Cython extension artifact not found (vector_hotspot_cython_nogil)."
          }
          Write-Host "Found extension artifact: $($mods[0].FullName)"

      - name: Build EXE
        run: uv run pyinstaller --noconfirm compress.spec

      - name: Create SHA256
        shell: pwsh
        run: |
          $hash = (Get-FileHash "dist/FireworksPDFCompressor.exe" -Algorithm SHA256).Hash
          Set-Content -Path "dist/FireworksPDFCompressor.exe.sha256" -Value $hash

      - name: Generate Release Notes
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $repo = "${{ github.repository }}"

          # Try to find previous tag for compare link (fallback to commits view)
          $prevTag = ""
          try {
            $prevTag = (git tag --sort=-v:refname | Where-Object { $_ -ne $tag } | Select-Object -First 1)
          } catch {
            $prevTag = ""
          }

          if ($prevTag -and $prevTag.Trim() -ne "") {
            $changelogUrl = "https://github.com/$repo/compare/$prevTag...$tag"
            $subjects = git log "$prevTag..$tag" --pretty=format:"%s"
          } else {
            $changelogUrl = "https://github.com/$repo/commits/$tag"
            $subjects = git log -n 20 --pretty=format:"%s" "$tag"
          }

          $groups = @{
            feat = New-Object System.Collections.Generic.List[string]
            fix = New-Object System.Collections.Generic.List[string]
            perf = New-Object System.Collections.Generic.List[string]
            chore = New-Object System.Collections.Generic.List[string]
            other = New-Object System.Collections.Generic.List[string]
          }

          foreach ($s in $subjects) {
            if (-not $s) { continue }
            $line = $s.Trim()
            if ($line -match '^(?i)feat(\(|:|\s)') {
              $groups.feat.Add($line)
            } elseif ($line -match '^(?i)fix(\(|:|\s)') {
              $groups.fix.Add($line)
            } elseif ($line -match '^(?i)perf(\(|:|\s)') {
              $groups.perf.Add($line)
            } elseif ($line -match '^(?i)chore(\(|:|\s)') {
              $groups.chore.Add($line)
            } else {
              $groups.other.Add($line)
            }
          }

          function Convert-ToBullets([System.Collections.Generic.List[string]]$items, [string]$emptyText) {
            if ($items.Count -eq 0) {
              return "- $emptyText"
            }
            return (($items | ForEach-Object { "- $_" }) -join "`n")
          }

          $featMd = Convert-ToBullets $groups.feat "无"
          $fixMd = Convert-ToBullets $groups.fix "无"
          $perfMd = Convert-ToBullets $groups.perf "无"
          $choreMd = Convert-ToBullets $groups.chore "无"
          $otherMd = Convert-ToBullets $groups.other "无"

          @"
          ## Fireworks PDF Compressor ML $tag

          ### 中文
          本版本提供面向 GitHub 托管场景的 PDF 优化能力更新，并附带可直接下载的 Windows 预构建包。

          #### 发布内容
          - PDF 压缩流水线（无损优先 + 有损交错）
          - 可选 ML 图像处理链路（去水印 / 增强 / 去噪 / 文档优化）
          - 预构建 Windows 可执行文件（EXE）与 SHA256 校验文件

          #### 变更摘要（按类型）
          ##### Feat
          $featMd

          ##### Fix
          $fixMd

          ##### Perf
          $perfMd

          ##### Chore
          $choreMd

          ##### Other
          $otherMd

          #### 合规说明
          - 仓库许可证：MPL-2.0
          - 发布包包含 `gs/`（Ghostscript 运行时）
          - 模型文件可能存在独立许可条款，二次分发前请确认

          ---

          ### English
          This release includes updates for GitHub-oriented PDF optimization workflows, with ready-to-use Windows prebuilt artifacts.

          #### Included
          - PDF compression pipeline (lossless-first + interleaved lossy)
          - Optional ML image pipeline (watermark handling / enhancement / denoising / document optimization)
          - Prebuilt Windows executable (EXE) and SHA256 checksum file

          #### Change Summary (by commit type)
          ##### Feat
          $featMd

          ##### Fix
          $fixMd

          ##### Perf
          $perfMd

          ##### Chore
          $choreMd

          ##### Other
          $otherMd

          #### Compliance
          - Repository license: MPL-2.0
          - Release package bundles `gs/` (Ghostscript runtime)
          - Model files may have separate redistribution terms

          ---

          **Full Changelog**: $changelogUrl
          "@ | Set-Content -Path "RELEASE_NOTES.md" -Encoding UTF8

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: false
          body_path: RELEASE_NOTES.md
          files: |
            dist/FireworksPDFCompressor.exe
            dist/FireworksPDFCompressor.exe.sha256
